                if (response.ok) {
                    const stats = await response.json();
                    document.getElementById('stat-unprocessed').textContent = stats.unprocessed_items || 0;
                    
                    if (stats.next_run) {
                        const nextRun = new Date(stats.next_run);
                        const now = new Date();
                        const diff = Math.floor((nextRun - now) / 1000 / 60); // minutes
                        
                        if (diff < 60) {
                            document.getElementById('stat-next-run').textContent = diff + 'm';
                        } else if (diff < 1440) {
                            document.getElementById('stat-next-run').textContent = Math.floor(diff / 60) + 'h';
                        } else {
                            document.getElementById('stat-next-run').textContent = Math.floor(diff / 1440) + 'd';
                        }
                    }
                }

                const healthResponse = await fetch('/health');
                if (healthResponse.ok) {
                    document.getElementById('status-badge').className = 'status-badge healthy';
                    document.getElementById('status-text').textContent = 'Healthy';
                } else {
                    document.getElementById('status-badge').className = 'status-badge error';
                    document.getElementById('status-text').textContent = 'Error';
                }
            } catch (error) {
                document.getElementById('status-badge').className = 'status-badge error';
                document.getElementById('status-text').textContent = 'Offline';
            }
        }

        // Load webhook URL
        async function loadWebhookUrl() {
            const hostname = window.location.hostname;
            const port = window.location.port || '5667';
            document.getElementById('webhook-url').textContent = `http://${hostname}:${port}/webhook`;
        }

        // Send test digest
        async function sendTestDigest() {
            showAlert('Sending test digest...', 'info');
            
            try {
                const response = await fetch('/api/send-digest', { method: 'POST' });
                const result = await response.json();
                
                if (response.ok) {
                    showAlert(result.message || 'Test digest sent successfully!', 'success');
                } else {
                    showAlert(result.detail || 'Failed to send test digest', 'error');
                }
            } catch (error) {
                showAlert('Failed to send test digest', 'error');
            }
        }

        // Test Discord webhook
        async function testDiscordWebhook() {
            showAlert('Sending test message to Discord...', 'info');
            
            try {
                const response = await fetch('/api/test-discord', { method: 'POST' });
                const result = await response.json();
                
                if (response.ok) {
                    showAlert('Test message sent to Discord!', 'success');
                } else {
                    showAlert(result.detail || 'Failed to send test message', 'error');
                }
            } catch (error) {
                showAlert('Failed to send test message', 'error');
            }
        }

        // Refresh logs
        async function refreshLogs() {
            try {
                const response = await fetch('/api/logs?lines=500');
                if (response.ok) {
                    const data = await response.json();
                    
                    // Update log info
                    document.getElementById('logs-count').textContent = data.count;
                    document.getElementById('logs-size').textContent = 
                        data.file_info.size_mb ? `${data.file_info.size_mb} MB` : '0 MB';
                    
                    // Render logs
                    const container = document.getElementById('logs-container');
                    if (data.logs.length === 0) {
                        container.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 2rem;">No logs available yet</div>';
                    } else {
                        container.innerHTML = data.logs.map(log => {
                            const levelClass = `log-level-${log.level}`;
                            return `
                                <div class="log-entry">
                                    <span class="log-timestamp">${log.timestamp}</span>
                                    <span class="log-level ${levelClass}">${log.level}</span>
                                    <span class="log-message">${escapeHtml(log.message)}</span>
                                </div>
                            `;
                        }).join('');
                        
                        // Auto-scroll to bottom
                        container.scrollTop = container.scrollHeight;
                    }
                } else {
                    showAlert('Failed to load logs', 'error');
                }
            } catch (error) {
                showAlert('Failed to load logs', 'error');
            }
        }

        // Load queue
        async function loadQueue() {
            try {
                const response = await fetch('/api/queue');
                if (response.ok) {
                    const data = await response.json();
                    const content = document.getElementById('queue-content');
                    
                    if (data.total_count === 0) {
                        content.innerHTML = `
                            <div class="empty-queue">
                                <div class="empty-queue-icon">ðŸ“­</div>
                                <p>Queue is empty</p>
                                <p style="font-size: 0.875rem; color: var(--text-secondary); margin-top: 0.5rem;">
                                    New items from Plex will appear here
                                </p>
                            </div>
                        `;
                    } else {
                        let html = '';
                        
                        // Movies
                        if (data.movies.length > 0) {
                            html += `
                                <div class="queue-section">
                                    <h3>ðŸŽ¬ Movies (${data.counts.movies})</h3>
                                    <ul class="queue-list">
                            `;
                            data.movies.forEach(item => {
                                html += `
                                    <li class="queue-item">
                                        <div class="queue-item-content">
                                            <div class="queue-item-title">${escapeHtml(item.display)}</div>
                                            <div class="queue-item-meta">Added: ${new Date(item.added_at).toLocaleString()}</div>
                                        </div>
                                        <span class="queue-badge queue-badge-movie">MOVIE</span>
                                    </li>
                                `;
                            });
                            html += '</ul></div>';
                        }
                        
                        // TV Shows
                        if (data.tv_shows.length > 0) {
                            html += `
                                <div class="queue-section">
                                    <h3>ðŸ“º TV Shows (${data.counts.tv_shows})</h3>
                                    <ul class="queue-list">
                            `;
                            data.tv_shows.forEach(item => {
                                html += `
                                    <li class="queue-item">
                                        <div class="queue-item-content">
                                            <div class="queue-item-title">${escapeHtml(item.display)}</div>
                                            <div class="queue-item-meta">Added: ${new Date(item.added_at).toLocaleString()}</div>
                                        </div>
                                        <span class="queue-badge queue-badge-tv">TV</span>
                                    </li>
                                `;
                            });
                            html += '</ul></div>';
                        }
                        
                        // Music
                        if (data.music.length > 0) {
                            html += `
                                <div class="queue-section">
                                    <h3>ðŸŽµ Music (${data.counts.music})</h3>
                                    <ul class="queue-list">
                            `;
                            data.music.forEach(item => {
                                html += `
                                    <li class="queue-item">
                                        <div class="queue-item-content">
                                            <div class="queue-item-title">${escapeHtml(item.display)}</div>
                                            <div class="queue-item-meta">Added: ${new Date(item.added_at).toLocaleString()}</div>
                                        </div>
                                        <span class="queue-badge queue-badge-music">MUSIC</span>
                                    </li>
                                `;
                            });
                            html += '</ul></div>';
                        }
                        
                        content.innerHTML = html;
                    }
                }
            } catch (error) {
                showAlert('Failed to load queue', 'error');
            }
        }

        // Utility function to escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Show alert
        function showAlert(message, type) {
            const container = document.getElementById('alert-container');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.innerHTML = `
                <span>${message}</span>
            `;
            
            container.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }
    </script>
</body>
</html>
